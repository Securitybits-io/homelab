# In order to deploy the private and pubkey run the following command
# ansible-playbook -i production playbooks/provision-ssh-key.yml --ask-vault-pass --user=provision --ask-pass

---
- hosts: ansible
  become: true
  gather_facts: false
  vars:
    public_key: |
      ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCiuk/CSB3//1AH1QWaDOoZzeaxIEn9LfXP41vrKtqRrV1fiHRfYSul2C8M9ReJyHWGasHhEf57Mf+9Hrdg4Kdi+aIgqh4m5SfarMmSfO4LL1SBUBoopr/egClDQAy9hNKTdSC1IjVxOQKZzJGMFJ26aKkHgiQGT2hPVB1p+YbcYgsQmAQgZ763IVkHyeYwuSnSijQRNwbj/etqyp4hpyAFQ11rqczqO385AuZERxagvb39Gp0N334mg4ASitgmssNeAKBSVbACXDN62eXekX1B+UBIPDJ1e7X1ViyyQXidD5DRHM/4XF2i/XWvGWwgMo4DfNaFVvjy5hQorvvnmcJO/8RDIcAKviw/PIY729+Ci7AZ8YOEOD3QeB8swaZjyn/+MNFaYiXY2z7kat3Ut4GWDxdKMMxFaDrSB0vnnNIvxNidZ/nI5TPrTBa9H3FkrJCYcq2e8oOv1cmqcYRw+Xt9UuDZL+wyTUUpvaAM3ABJW1CkmsLy7mMh9mlBVrEcKls= root@ansible
    private_key: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      39636563616561616161383366373430313565373233373865326230363533633535373065383132
      3235366437373937626434336538633634306134663563340a376562323134316532646639616433
      63336139663433386635393466346164376433326430646531663739353135336561666565326563
      6338663135343236380a656366663838323066326631666538346632313736656438303031353137
      62366637303937343161643032306332636635666635656437633530313565383836363931643336
      30616566373464346334633461623262323033663439383265346366656563373932323335393839
      32623137363862306165366262376430643266336462376464613634623430363832613734396261
      32633638343432623833626537666430393361636634313232353361323466386133393464383436
      32653766373363373137356232633630303663393437666461626564323562343035343563343831
      35316633336662336539376464306232363766653465653930633834393935623430623436653232
      37393964656139633033353364623266333235306564313961386462383162616137393434633230
      34636566653262356236623664323532653137646539326130653530613236643836386234383665
      32383037663666336461356239653564633932333561663664653465393065623366363964303239
      62613134626233313936633665306630613036356632333837363935633066356531636562353963
      39373136623366666235393561346131656536653966666130613737333263353166393535316435
      34663062363362316330323233343561393439333830393365346437396136373139613839393531
      38653435346332316436333539313362616437353566303561633232326634336637353532653663
      64633738323661376562333631666136333637313334343263373730323564626433336662303061
      37316436633236343561623137346563336534666537393037363763353930316235386565343636
      65613636666138616337373330346134613539333066323734626432376637336332636138343530
      38356236613937663035343035613366313032343861313162663365313464386666376365303039
      66386634333164663163613761333631333330613065353436346364643464643237643335646637
      36303030623232656133663062666334656131356564616336623038386234623731323336653261
      30356538306530316263633063613935613966633830333530376261623663346363386133346130
      34353534343564363962643339333330366230366534643930336237336636383762643832396432
      36386263666534653439393934323334393236613735323930313433656333386436643633633835
      61666364656334313831303132373037303231356338316461353437366236386266336163383831
      66363737646633333737633066326165646463386632633863653461653638346564333636363438
      39393565383263316466373462323764306434633231643134323264306466663435653662313862
      62633331383730646461656138666137396234616630636132363931376237373961336230323136
      30333162626631626662656665373862623134373765366262623836646436396433303237643961
      66636535613762363665626534336338383933636334643231633364333236313133373931653363
      34326131616565396165376133666131373234633833326239396633613334666538363630643766
      37396236336339323236386431633830303633663464643238613632393466306332333331616637
      31333037343732323530666265303064343631386337303231346565323036376139376630666133
      37326633353136303362356634633535653139306637346161303664653963643266643635626236
      62633133633462663633333036653737633338373633356433316237616164616336306465313561
      37343663366562656163646631336136356236326632316264323166343561663563623031613736
      65323466363361356534373666666665376439396230323161633963643633663664303231346534
      34653532376432343839626534336337316130343735343032623134306436316334646234316464
      39373933313465646163616162613665386134303030663965346331356431393330623462613537
      65643165613561653736356135383738336332633038323435363065333537663435383133656433
      32313535356434396462363464373761643130633861313861643333653333643532323232376464
      32326237323262333461333966636265323062343864363866306630323533316164323531383738
      63623834393666353665366135663264353336396639356662333265373563396631386666626161
      30306239316461303333613031383163333138663334613830646163376266323438613464316134
      61636562666166306238396330353066613965653364646166633664333533366133613235666436
      32346664316263386234636534396132386337653061643130343061663436666637343737643533
      31396131333461383661386662636161633439363237623464623832363833353134613637623235
      37333933396238326537383835363531363036643461643961633537383438303763383432346130
      34316337343930393432363966646631356530373433323764363661663430653031316431393463
      65653732616661363338323531663235326332366365306461313265653432323735353866636330
      62666337396665313130303361373736393838396665343665376638323638396462376530653639
      32356661663436353834363831376562666239303862393165383636383065643263396430323162
      37303063356432646665343730373561613232396237663461373533386537373964613434663639
      62623637666637653838373362303066353266333135353637373562373237636633363063623364
      38326434383132373865636437643237616365643137373166643839363961656438646231636236
      39313635656331313337373536353064636635356131343937616237623235303434386361393035
      61613434623038623132303930613939323430643064383465383666323731316434316330346333
      64623961613331626435303430316638326164383538366431363634393936316536613931383534
      34353035306636363262383731643630303966323865316666383838663130636264346338313133
      33333430343563313832356533626533313535313261353435353032663435343232333065653564
      33383464643466396565333036663564613930633365623531663138393938363236363431323861
      31353263393939613232646431383839636266303032353935303331303136373764373932643630
      30386138323438616661386331323838363362653666626536666234663539303239393738373062
      65363265353335633534343933363666353561626132633435353534613461343632323036356231
      30613564343031623365356661663137666162323734653733326539613039363935636236366433
      35653333633162323861656236373530636565356437613731336637626332636164303330393065
      65613062393333376464366434643866366265623438613938643062386537343035343739343938
      35333961626665636463333431396134323632643831626133636466363638626535386438643063
      62363161616563663266633962613866346463616332643761303038653964346261646130393963
      33356530386662323730306662373632626637386562626132623532616330313563656136643936
      62623163313661623838383666346337623939613939353331363565653461643130353531326463
      65643037383931343465313464653166383663303632383465393665353165333564336464353166
      65613065343636303936663165313838663331636135363163313333623861383435396665393835
      32373762353332326432653736373631303265313839323234336164666630616163626632333163
      65323061373966396130363838666431303336386330363032373630383333623561336236316266
      31663234633564316465393337376164363331613962343235666662613832653161353266633465
      65316534323431643939386335306337303232656364306666613962613663633664316239363839
      36383664376530376336653733313666333362643433646439316363376335386661396661626432
      39353731613166313235313263663431326136323339336366333534656632323766623233366431
      63626234323366636366343334333963386138356264623034656537313339383665353635616432
      62643836316566613834653133353566323130363361393832623764613263383035373132386362
      35323539613863386261303433613062363962623634343439363337323732396463323539656130
      31353039303461303030643333653965613066643131313963343831376463613939383065313532
      32643630316561616132623133623931613230653963336465623033303064366437386164306135
      66396337633136313665656133313831636530663862393664306239626432666432386332653966
      37386233666630346136613763626536626661623737343865613938303366386136303061333034
      65393462306135326166653065646534343530613430356236633862663531626237383634303733
      63313938666331613331383837643938613032623161356461323631363532383436313635333931
      34303834303336383534623531353235386261656439343464303765323566373536303531393762
      32336364633834383263646638313331376436646133396363613765316436383539613963323633
      39373161373365323366623437396564613263636637323265653834323565373563663163333562
      37383735623632306636633763653730396337613337636262333261316435313633613133373832
      61633861316636613339643431386532666336306631353133613030643636353533626164353936
      64376464386366643363623238623463366537373565373764663732313565376637383536396431
      31373264653836323936393039643835376464656638326531323664656163353035353236626661
      31663936633263386139613431323437396537613664326365653763623862393763323834383130
      31346634353938323565353833663536393365333866646563623063613061353036656463323464
      63336530666366663737366164313133666661316364666565656362393235663036616438363639
      37363638376437306632316565396538363766326166346434323839613062626334613063623962
      63353233623033613033653831613261373463643537616162633731393464396139613963643863
      37363961613131383765333964646534663138396331666564393537653564366565303630633561
      35663831366630353732616235646438663439353839613533636563303437393738323733393066
      37353665306439336462356265383334376431313139306538623931366466336533633565303330
      63663964306536346631613764303362663839373133336439646133343238663739636633343362
      31343931383838373861313263363337353161633265626364353664323632323537303762623430
      63333961636365363061386135376334303962396463643364613631353262313761653062393963
      34393734343136336538336135306534373639646662656264333839323066386230393132656438
      63656632303437653435376133353965333834623262353332623035333261363736396433373762
      35373966356365336562646535666165396538613035656162623137333535376562613131633935
      66393030373765643064326634316661326233363463363761306262663132356366303535353331
      33353166346431393037363636373132663431373437663830633538333462323866653664633434
      61306436326262343033313566356364636165343638313332316539653365643330313231366434
      35613836353332386431666162346532366165306435316664336239343632613034303265323961
      31643264316363346466666531643231323832643237643734326166343036346438343036623561
      61633836383966313338346132633063393238386437303831356438366336356265313563346565
      30356232663363383565373030303038613132626139333138333031343565366533356231346135
      37353664383932313738353162343139373462653439383634313464393939653863393062633035
      38366364623261313737343635356235366532626631623834623731333337333739613834383938
      35313733323532616330306333373938663433666337616438313161363765333232363332623430
      37353264613431356436663039366433316630333335636463303436613639326532343632626661
      38333533363166346564383230333764643834636430663831343765373466653935383132373631
      32323164623964616633656632336331333866613162396239623631363863393932353336666438
      37316332356366636430623266313830313634333163343961316234366439393761313632303638
      62303830393731386464373730376263346163343739666535383334663561616665376130363739
      30393237663735653136386465623565303066373032306537623032376134373534666636396335
      38306334346634306133633665303030343730343137333363386266326330326564656338396164
      39623866316631663266616162616165313166613530326333316636386434356166373030653138
      37653633636564623931383830353732316266303333313333666232323062616432313636333165
      35376262373635653066643437663339343336323733323161653931353934393937633565386531
      31653937343330376636623330643966633261386131613138613233623035663863393633333663
      62333233333233386133343066306332666331323133353431323562366638663435313365623366
      32396333656265616237353964636233333631663037313435616263393638393037616465313563
      646261386631393661393765323033643139

  tasks:

  - name: Ensure that /root/.ssh exists
    file:
      dest: "/root/.ssh"
      mode: "0700"
      owner: root
      state: directory

  - name: Decrypt and Store Private Key in /root/.ssh
    copy:
      dest: /root/.ssh/id_rsa
      content: "{{ private_key }}"
      mode: "0600"
      owner: root

- hosts: all
  become: True
  gather_facts: no
  vars:
    public_key: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCiuk/CSB3//1AH1QWaDOoZzeaxIEn9LfXP41vrKtqRrV1fiHRfYSul2C8M9ReJyHWGasHhEf57Mf+9Hrdg4Kdi+aIgqh4m5SfarMmSfO4LL1SBUBoopr/egClDQAy9hNKTdSC1IjVxOQKZzJGMFJ26aKkHgiQGT2hPVB1p+YbcYgsQmAQgZ763IVkHyeYwuSnSijQRNwbj/etqyp4hpyAFQ11rqczqO385AuZERxagvb39Gp0N334mg4ASitgmssNeAKBSVbACXDN62eXekX1B+UBIPDJ1e7X1ViyyQXidD5DRHM/4XF2i/XWvGWwgMo4DfNaFVvjy5hQorvvnmcJO/8RDIcAKviw/PIY729+Ci7AZ8YOEOD3QeB8swaZjyn/+MNFaYiXY2z7kat3Ut4GWDxdKMMxFaDrSB0vnnNIvxNidZ/nI5TPrTBa9H3FkrJCYcq2e8oOv1cmqcYRw+Xt9UuDZL+wyTUUpvaAM3ABJW1CkmsLy7mMh9mlBVrEcKls= root@ansible
  tasks:
    
  - name: Ensure that /root/.ssh exists
    file:
      dest: "/root/.ssh"
      mode: "0700"
      owner: root
      state: directory

  - name: Add RSA public key to the remote host
    authorized_key: 
      user: root 
      key: "{{ public_key }}"