---
- hosts: nomad_servers
  gather_facts: yes
  become: yes
  vars:
    nomad_type: server
    consul_type: client
    use_consul: true
  roles:
    - common
    - cis
    - ssh
    - consul
    - docker
    - nomad
    - nomad_cni_plugins
  tasks:
    - name: Copy folder to /opt/jobs
      ansible.builtin.copy:
        src: ../jobs  # Local folder on the Ansible controller
        dest: /opt    # Target directory on the node
        owner: root
        group: root
        mode: '0755'
      tags:
        jobs
    
    - name: Push nomad variables and secrets
      tags:
        - jobs
        - secrets
      block:
        - name: Find all job-var files
          find:
            paths: "{{ playbook_dir }}/host_vars/nomad/job-vars"
            patterns: "*.nv.hcl"
          register: job_var_files

        - name: Read the content of job-var files
          slurp:
            src: "{{ item.path }}"
          with_items: "{{ job_var_files.files }}"
          register: slurped_files

        - name: Apply Nomad var from file content
          shell: |
            nomad var put -force @- <<EOF
            {{ (item.content | b64decode) }}
            EOF
          with_items: "{{ slurped_files.results }}"


- hosts: nomad_clients
  gather_facts: yes
  become: yes
  vars:
    nomad_type: client  # Nomad server/client
    consul_type: client # Consul server/client
    use_consul: true
  roles:
    - common
    - cis
    - ssh
    - consul
    - docker
    - nomad
    - nomad_cni_plugins
